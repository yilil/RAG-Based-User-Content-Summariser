digraph Flowchart {
  rankdir=TB;
  node [style=filled, fontname=Helvetica, margin=0.3];
  
  // Input with all 8 documents
  Input [label="Input Query: 'Recommend fruit juices'\n\nInitial Data (8 documents):\n
1. Best Fruit Juice Rankings (200 upvotes)\n   Content: 'Fresh juice recommendations: apple juice (5 stars) - crisp and sweet,\n            pear juice (4 stars) - mild and refreshing,\n            orange juice (3 stars) - classic choice'\n
2. Summer Juice Review (200 upvotes)\n   Content: 'Best summer juices: apple juice (4 stars) - perfect for hot days,\n            pear juice (4 stars) - light and refreshing,\n            grape juice (5 stars) - rich and sweet'\n
3. Healthy Juice Guide (150 upvotes)\n   Content: 'My favorite fresh juices: apple juice (4 stars) - great antioxidants,\n            grape juice (5 stars) - full of nutrients,\n            orange juice (4 stars) - vitamin C boost'\n
4. Grape Juice Special (150 upvotes)\n   Content: 'Pure grape juice is the best drink! Natural sweetness and rich flavor (5 stars).\n            Perfect for both adults and kids.'\n
5. Controversial Juice Review (50 upvotes)\n   Content: 'Mixed feelings about these juices: apple juice (2 stars) - too sweet,\n            grape juice (1 star) - artificial taste,\n            orange juice (3 stars) - just okay'\n
6. Beverage Discussion (100 upvotes)\n   Content: 'Talking about drinks in general. Some juice mentions: apple juice is okay.\n            Also coffee and tea are great.'\n
7. Coffee Reviews (300 upvotes)\n   Content: 'Best coffee brands and brewing methods. No juice content here.'\n
8. Tea Appreciation (250 upvotes)\n   Content: 'Different types of tea and their benefits.'", 
   shape=box, fillcolor=lightblue];

  // Hybrid Retrieval System
  subgraph cluster_hybrid {
    label="Hybrid Retrieval System";
    style=filled;
    fillcolor=lightgreen;
    
    BM25 [label="BM25 Text Search (0.3)\n\nScores for all documents:\n1. Best Fruit Juice Rankings: 0.95\n2. Summer Juice Review: 0.92\n3. Healthy Juice Guide: 0.88\n4. Grape Juice Special: 0.85\n5. Controversial Juice Review: 0.82\n6. Beverage Discussion: 0.45\n7. Coffee Reviews: 0.15\n8. Tea Appreciation: 0.10", shape=box];
    
    Embedding [label="Embedding Similarity (0.4)\n\nScores for all documents:\n1. Best Fruit Juice Rankings: 0.94\n2. Summer Juice Review: 0.91\n3. Healthy Juice Guide: 0.87\n4. Grape Juice Special: 0.84\n5. Controversial Juice Review: 0.80\n6. Beverage Discussion: 0.40\n7. Coffee Reviews: 0.20\n8. Tea Appreciation: 0.15", shape=box];
    
    Social [label="Social Score (0.3)\n\nNormalized scores:\n1. Coffee Reviews: 1.00 (300 upvotes)\n2. Tea Appreciation: 0.83 (250 upvotes)\n3. Best Fruit Juice Rankings: 0.67 (200 upvotes)\n4. Summer Juice Review: 0.67 (200 upvotes)\n5. Healthy Juice Guide: 0.50 (150 upvotes)\n6. Grape Juice Special: 0.50 (150 upvotes)\n7. Beverage Discussion: 0.33 (100 upvotes)\n8. Controversial Review: 0.17 (50 upvotes)", shape=box];
  }

  // Combined Scores
  Combine [label="Combined Hybrid Scores\n\nFinal scores (weighted average):\n1. Best Fruit Juice Rankings: 0.86\n2. Summer Juice Review: 0.84\n3. Healthy Juice Guide: 0.76\n4. Grape Juice Special: 0.74\n5. Controversial Review: 0.62\n6. Coffee Reviews: 0.45\n7. Beverage Discussion: 0.40\n8. Tea Appreciation: 0.36\n\nTop 5 selected for next stage", shape=box, fillcolor=lightgreen];

  // Content Processing - LLM Extraction
  subgraph cluster_llm_extraction {
    label="LLM Information Extraction (Top 5 only)";
    style=filled;
    fillcolor=orange;
    
    Extract [label="LLM Extract Items and Posts\n\nItems identified:\n1. Apple Juice\n   - 3 posts with upvotes and sentiment ratings\n2. Grape Juice\n   - 3 posts with upvotes and sentiment ratings\n3. Orange Juice\n   - 2 posts with upvotes and sentiment ratings\n4. Pear Juice\n   - 2 posts with upvotes and sentiment ratings", shape=box];
    
    Sentiment [label="LLM Sentiment Analysis\n\nApple Juice posts:\n- Post1: 5 stars (crisp and sweet)\n- Post2: 4 stars (perfect for hot days)\n- Post3: 4 stars (great antioxidants)\n\nGrape Juice posts:\n- Post1: 5 stars (rich and sweet)\n- Post2: 5 stars (full of nutrients)\n- Post3: 5 stars (natural sweetness)\n\nOrange Juice posts:\n- Post1: 3 stars (classic choice)\n- Post2: 4 stars (vitamin C boost)\n\nPear Juice posts:\n- Post1: 4 stars (mild and refreshing)\n- Post2: 4 stars (light and refreshing)", shape=box];
    
    Summary [label="LLM Generate Summaries\n\nApple Juice:\n\"Apple juice receives high praise for being crisp,\nsweet, and refreshing, especially during hot weather.\nReviewers also appreciate its antioxidant properties.\"\n\nGrape Juice:\n\"Grape juice is highly praised for its natural sweetness,\nrich flavor, and nutritional value. All reviews are\nextremely positive.\"\n\nOrange Juice:\n\"Orange juice is appreciated as a classic choice with\ngood vitamin C content. Reviews are generally positive.\"\n\nPear Juice:\n\"Pear juice is consistently described as mild, light,\nand refreshing. Reviews are uniformly positive.\"", shape=box];
  }

  // Code Calculation
  subgraph cluster_code_calculation {
    label="Code Calculation";
    style=filled;
    fillcolor=plum;
    
    Aggregate [label="Calculate Aggregates\n\nApple Juice:\n- Total Upvotes: 550\n- Average Rating: 4.33\n- Mentions: 3\n\nGrape Juice:\n- Total Upvotes: 500\n- Average Rating: 5.0\n- Mentions: 3\n\nOrange Juice:\n- Total Upvotes: 350\n- Average Rating: 3.5\n- Mentions: 2\n\nPear Juice:\n- Total Upvotes: 400\n- Average Rating: 4.0\n- Mentions: 2", shape=box];
    
    Normalize [label="Normalize Components\n\nMax Values:\n- Max Upvotes: 550\n- Max Rating: 5.0\n- Max Mentions: 3\n\nNormalized Components:\n- Apple Juice: rating=0.866, upvotes=1.000, mentions=1.000\n- Grape Juice: rating=1.000, upvotes=0.909, mentions=1.000\n- Orange Juice: rating=0.700, upvotes=0.636, mentions=0.667\n- Pear Juice: rating=0.800, upvotes=0.727, mentions=0.667", shape=box];
    
    Final_Score [label="Apply Weights and Calculate Final Scores\n\nWeights: rating=0.4, upvotes=0.35, mentions=0.25\n\nApple Juice:\n0.4*(0.866) + 0.35*(1.000) + 0.25*(1.000) = 0.946\n\nGrape Juice:\n0.4*(1.000) + 0.35*(0.909) + 0.25*(1.000) = 0.968\n\nOrange Juice:\n0.4*(0.700) + 0.35*(0.636) + 0.25*(0.667) = 0.669\n\nPear Juice:\n0.4*(0.800) + 0.35*(0.727) + 0.25*(0.667) = 0.744", shape=box];
  }

  // Result Processing
  subgraph cluster_result {
    label="Result Processing";
    style=filled;
    fillcolor=lightcoral;
    
    Format [label="Final Ranked Results:\n\n1. Grape Juice\n   Rating: 5.0 (3 reviews)\n   Upvotes: 500\n   Score: 0.968\n   Summary: \"Grape juice is highly praised for its natural sweetness,\n   rich flavor, and nutritional value.\"\n\n2. Apple Juice\n   Rating: 4.33 (3 reviews)\n   Upvotes: 550\n   Score: 0.946\n   Summary: \"Apple juice receives high praise for being crisp,\n   sweet, and refreshing, especially during hot weather.\"\n\n3. Pear Juice\n   Rating: 4.0 (2 reviews)\n   Upvotes: 400\n   Score: 0.744\n   Summary: \"Pear juice is consistently described as mild, light,\n   and refreshing.\"\n\n4. Orange Juice\n   Rating: 3.5 (2 reviews)\n   Upvotes: 350\n   Score: 0.669\n   Summary: \"Orange juice is appreciated as a classic choice with\n   good vitamin C content.\"", shape=box];
  }

  // Connections
  Input -> BM25;
  Input -> Embedding;
  Input -> Social;
  
  BM25 -> Combine;
  Embedding -> Combine;
  Social -> Combine;
  
  Combine -> Extract;
  Extract -> Sentiment;
  Sentiment -> Summary;
  
  Summary -> Aggregate;
  Aggregate -> Normalize;
  Normalize -> Final_Score;
  Final_Score -> Format;
  
  Format -> Output;
  
  Output [label="Return top 4 ranked juices with summaries", shape=ellipse, fillcolor=lightblue];
}